import{d as Z}from"./index-CtTpLCZM.js";var ee={trailer:59};function j(e=256){let t=0,l=new Uint8Array(e);return{get buffer(){return l.buffer},reset(){t=0},bytesView(){return l.subarray(0,t)},bytes(){return l.slice(0,t)},writeByte(i){r(t+1),l[t]=i,t++},writeBytes(i,n=0,o=i.length){r(t+o);for(let f=0;f<o;f++)l[t++]=i[f+n]},writeBytesView(i,n=0,o=i.byteLength){r(t+o),l.set(i.subarray(n,n+o),t),t+=o}};function r(i){var n=l.length;if(n>=i)return;var o=1024*1024;i=Math.max(i,n*(n<o?2:1.125)>>>0),n!=0&&(i=Math.max(i,256));let f=l;l=new Uint8Array(i),t>0&&l.set(f.subarray(0,t),0)}}var $=12,_=5003,te=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];function re(e,t,l,r,i=j(512),n=new Uint8Array(256),o=new Int32Array(_),f=new Int32Array(_)){let w=o.length,s=Math.max(2,r);n.fill(0),f.fill(0),o.fill(-1);let c=0,a=0,g=s+1,B=g,u=!1,p=B,h=(1<<p)-1,b=1<<g-1,I=b+1,v=b+2,y=0,A=l[0],k=0;for(let d=w;d<65536;d*=2)++k;k=8-k,i.writeByte(s),U(b);let m=l.length;for(let d=1;d<m;d++)e:{let C=l[d],F=(C<<$)+A,x=C<<k^A;if(o[x]===F){A=f[x];break e}let z=x===0?1:w-x;for(;o[x]>=0;)if(x-=z,x<0&&(x+=w),o[x]===F){A=f[x];break e}U(A),A=C,v<1<<$?(f[x]=v++,o[x]=F):(o.fill(-1),v=b+2,u=!0,U(b))}return U(A),U(I),i.writeByte(0),i.bytesView();function U(d){for(c&=te[a],a>0?c|=d<<a:c=d,a+=p;a>=8;)n[y++]=c&255,y>=254&&(i.writeByte(y),i.writeBytesView(n,0,y),y=0),c>>=8,a-=8;if((v>h||u)&&(u?(p=B,h=(1<<p)-1,u=!1):(++p,h=p===$?1<<p:(1<<p)-1)),d==I){for(;a>0;)n[y++]=c&255,y>=254&&(i.writeByte(y),i.writeBytesView(n,0,y),y=0),c>>=8,a-=8;y>0&&(i.writeByte(y),i.writeBytesView(n,0,y),y=0)}}}var ne=re;function J(e,t,l){return e<<8&63488|t<<2&992|l>>3}function K(e,t,l,r){return e>>4|t&240|(l&240)<<4|(r&240)<<8}function Q(e,t,l){return e>>4<<8|t&240|l>>4}function q(e,t,l){return e<t?t:e>l?l:e}function D(e){return e*e}function W(e,t,l){var r=0,i=1e100;let n=e[t],o=n.cnt;n.ac;let f=n.rc,w=n.gc,s=n.bc;for(var c=n.fw;c!=0;c=e[c].fw){let g=e[c],B=g.cnt,u=o*B/(o+B);if(!(u>=i)){var a=0;a+=u*D(g.rc-f),!(a>=i)&&(a+=u*D(g.gc-w),!(a>=i)&&(a+=u*D(g.bc-s),!(a>=i)&&(i=a,r=c)))}}n.err=i,n.nn=r}function H(){return{ac:0,rc:0,gc:0,bc:0,cnt:0,nn:0,fw:0,bk:0,tm:0,mtm:0,err:0}}function ae(e,t){let l=t==="rgb444"?4096:65536,r=new Array(l),i=e.length;if(t==="rgba4444")for(let n=0;n<i;++n){let o=e[n],f=o>>24&255,w=o>>16&255,s=o>>8&255,c=o&255,a=K(c,s,w,f),g=a in r?r[a]:r[a]=H();g.rc+=c,g.gc+=s,g.bc+=w,g.ac+=f,g.cnt++}else if(t==="rgb444")for(let n=0;n<i;++n){let o=e[n],f=o>>16&255,w=o>>8&255,s=o&255,c=Q(s,w,f),a=c in r?r[c]:r[c]=H();a.rc+=s,a.gc+=w,a.bc+=f,a.cnt++}else for(let n=0;n<i;++n){let o=e[n],f=o>>16&255,w=o>>8&255,s=o&255,c=J(s,w,f),a=c in r?r[c]:r[c]=H();a.rc+=s,a.gc+=w,a.bc+=f,a.cnt++}return r}function L(e,t,l={}){let{format:r="rgb565",clearAlpha:i=!0,clearAlphaColor:n=0,clearAlphaThreshold:o=0,oneBitAlpha:f=!1}=l;if(!e||!e.buffer)throw new Error("quantize() expected RGBA Uint8Array data");if(!(e instanceof Uint8Array)&&!(e instanceof Uint8ClampedArray))throw new Error("quantize() expected RGBA Uint8Array data");let w=new Uint32Array(e.buffer),s=l.useSqrt!==!1,c=r==="rgba4444",a=ae(w,r),g=a.length,B=g-1,u=new Uint32Array(g+1);for(var p=0,h=0;h<g;++h){let M=a[h];if(M!=null){var b=1/M.cnt;c&&(M.ac*=b),M.rc*=b,M.gc*=b,M.bc*=b,a[p++]=M}}D(t)/p<.022&&(s=!1);for(var h=0;h<p-1;++h)a[h].fw=h+1,a[h+1].bk=h,s&&(a[h].cnt=Math.sqrt(a[h].cnt));s&&(a[h].cnt=Math.sqrt(a[h].cnt));var I,v,y;for(h=0;h<p;++h){W(a,h);var A=a[h].err;for(v=++u[0];v>1&&(y=v>>1,!(a[I=u[y]].err<=A));v=y)u[v]=I;u[v]=h}var k=p-t;for(h=0;h<k;){for(var m;;){var U=u[1];if(m=a[U],m.tm>=m.mtm&&a[m.nn].mtm<=m.tm)break;m.mtm==B?U=u[1]=u[u[0]--]:(W(a,U),m.tm=h);var A=a[U].err;for(v=1;(y=v+v)<=u[0]&&(y<u[0]&&a[u[y]].err>a[u[y+1]].err&&y++,!(A<=a[I=u[y]].err));v=y)u[v]=I;u[v]=U}var d=a[m.nn],C=m.cnt,F=d.cnt,b=1/(C+F);c&&(m.ac=b*(C*m.ac+F*d.ac)),m.rc=b*(C*m.rc+F*d.rc),m.gc=b*(C*m.gc+F*d.gc),m.bc=b*(C*m.bc+F*d.bc),m.cnt+=d.cnt,m.mtm=++h,a[d.bk].fw=d.fw,a[d.fw].bk=d.bk,d.mtm=B}let x=[];var z=0;for(h=0;;++z){let M=q(Math.round(a[h].rc),0,255),O=q(Math.round(a[h].gc),0,255),T=q(Math.round(a[h].bc),0,255),V=255;c&&(V=q(Math.round(a[h].ac),0,255),f&&(V=V<=(typeof f=="number"?f:127)?0:255),i&&V<=o&&(M=O=T=n,V=0));let P=c?[M,O,T,V]:[M,O,T];if(ie(x,P)||x.push(P),(h=a[h].fw)==0)break}return x}function ie(e,t){for(let l=0;l<e.length;l++){let r=e[l],i=r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2],n=r.length>=4&&t.length>=4?r[3]===t[3]:!0;if(i&&n)return!0}return!1}function S(e,t,l="rgb565"){if(!e||!e.buffer)throw new Error("quantize() expected RGBA Uint8Array data");if(!(e instanceof Uint8Array)&&!(e instanceof Uint8ClampedArray))throw new Error("quantize() expected RGBA Uint8Array data");if(t.length>256)throw new Error("applyPalette() only works with 256 colors or less");let r=new Uint32Array(e.buffer),i=r.length,n=l==="rgb444"?4096:65536,o=new Uint8Array(i),f=new Array(n);if(l==="rgba4444")for(let w=0;w<i;w++){let s=r[w],c=s>>24&255,a=s>>16&255,g=s>>8&255,B=s&255,u=K(B,g,a,c),p=u in f?f[u]:f[u]=oe(B,g,a,c,t);o[w]=p}else{let w=l==="rgb444"?Q:J;for(let s=0;s<i;s++){let c=r[s],a=c>>16&255,g=c>>8&255,B=c&255,u=w(B,g,a),p=u in f?f[u]:f[u]=le(B,g,a,t);o[s]=p}}return o}function oe(e,t,l,r,i){let n=0,o=1e100;for(let f=0;f<i.length;f++){let w=i[f],s=w[3],c=G(s-r);if(c>o)continue;let a=w[0];if(c+=G(a-e),c>o)continue;let g=w[1];if(c+=G(g-t),c>o)continue;let B=w[2];c+=G(B-l),!(c>o)&&(o=c,n=f)}return n}function le(e,t,l,r){let i=0,n=1e100;for(let o=0;o<r.length;o++){let f=r[o],w=f[0],s=G(w-e);if(s>n)continue;let c=f[1];if(s+=G(c-t),s>n)continue;let a=f[2];s+=G(a-l),!(s>n)&&(n=s,i=o)}return i}function G(e){return e*e}function fe(e={}){let{initialCapacity:t=4096,auto:l=!0}=e,r=j(t),i=5003,n=new Uint8Array(256),o=new Int32Array(i),f=new Int32Array(i),w=!1;return{reset(){r.reset(),w=!1},finish(){r.writeByte(ee.trailer)},bytes(){return r.bytes()},bytesView(){return r.bytesView()},get buffer(){return r.buffer},get stream(){return r},writeHeader:s,writeFrame(c,a,g,B={}){let{transparent:u=!1,transparentIndex:p=0,delay:h=0,palette:b=null,repeat:I=0,colorDepth:v=8,dispose:y=-1}=B,A=!1;if(l?w||(A=!0,s(),w=!0):A=!!B.first,a=Math.max(0,Math.floor(a)),g=Math.max(0,Math.floor(g)),A){if(!b)throw new Error("First frame must include a { palette } option");we(r,a,g,b,v),Y(r,b),I>=0&&se(r,I)}let k=Math.round(h/10);ce(r,y,k,u,p);let m=!!b&&!A;ue(r,a,g,m?b:null),m&&Y(r,b),he(r,c,a,g,v,n,o,f)}};function s(){X(r,"GIF89a")}}function ce(e,t,l,r,i){e.writeByte(33),e.writeByte(249),e.writeByte(4),i<0&&(i=0,r=!1);var n,o;r?(n=1,o=2):(n=0,o=0),t>=0&&(o=t&7),o<<=2,e.writeByte(0|o|0|n),E(e,l),e.writeByte(i||0),e.writeByte(0)}function we(e,t,l,r,i=8){let n=1,o=0,f=N(r.length)-1,w=n<<7|i-1<<4|o<<3|f;E(e,t),E(e,l),e.writeBytes([w,0,0])}function se(e,t){e.writeByte(33),e.writeByte(255),e.writeByte(11),X(e,"NETSCAPE2.0"),e.writeByte(3),e.writeByte(1),E(e,t),e.writeByte(0)}function Y(e,t){let l=1<<N(t.length);for(let r=0;r<l;r++){let i=[0,0,0];r<t.length&&(i=t[r]),e.writeByte(i[0]),e.writeByte(i[1]),e.writeByte(i[2])}}function ue(e,t,l,r){if(e.writeByte(44),E(e,0),E(e,0),E(e,t),E(e,l),r){let i=0,n=0,o=N(r.length)-1;e.writeByte(128|i|n|0|o)}else e.writeByte(0)}function he(e,t,l,r,i=8,n,o,f){ne(l,r,t,i,e,n,o,f)}function E(e,t){e.writeByte(t&255),e.writeByte(t>>8&255)}function X(e,t){for(var l=0;l<t.length;l++)e.writeByte(t.charCodeAt(l))}function N(e){return Math.max(Math.ceil(Math.log2(e)),1)}var R,me=async()=>{R=fe(),console.log("recording (gif) started")},be=({context:e,settings:t,states:l,props:r})=>{let i;if(t.mode==="2d"){i=e.getImageData(0,0,r.canvas.width,r.canvas.height).data;const n=t.gifOptions.palette||L(i,t.gifOptions.maxColors||256),o=S(i,n),w=1/t.exportFps*1e3;R.writeFrame(o,r.canvas.width,r.canvas.height,{palette:n,delay:w})}else if(t.mode==="webgpu"){const n=r.canvas,o=n.toDataURL("image/png"),f=new Image;f.src=o,f.onload=()=>{const w=document.createElement("canvas");w.width=n.width,w.height=n.height;const s=w.getContext("2d");s.drawImage(f,0,0),i=s.getImageData(0,0,w.width,w.height).data;const a=t.gifOptions.palette||L(i,t.gifOptions.maxColors||256),g=S(i,a),u=1/t.exportFps*1e3;R.writeFrame(g,r.canvas.width,r.canvas.height,{palette:a,delay:u})}}else{const n=e,o=new Uint8Array(n.drawingBufferWidth*n.drawingBufferHeight*4);n.readPixels(0,0,n.drawingBufferWidth,n.drawingBufferHeight,n.RGBA,n.UNSIGNED_BYTE,o);const f=t.gifOptions.palette||L(o,t.gifOptions.maxColors||256),w=S(o,f),c=1/t.exportFps*1e3;R.writeFrame(w,r.canvas.width,r.canvas.height,{palette:f,delay:c})}t.exportFps>50&&console.warn("clamping fps to 50, which is the maximum for GIF. animation duration will be inaccurate."),console.log(`recording (gif) frame... ${l.recordedFrames+1} of ${t.exportTotalFrames}`)},de=({settings:e})=>{R.finish();const l=R.bytesView();Z(new Blob([l],{type:"image/gif"}),e,"gif"),console.log("recording (gif) complete")};export{be as encodeGifAnim,de as endGifAnimRecord,me as setupGifAnimRecord};
